graph TD
    Start["üöÄ Development Phase Begins<br/>(After Product Discovery<br/>& Specification)"] 
    
    Start --> ContextPhase["üìö Stage 1: <br> CONTEXT PROVIDING"]
    
    ContextPhase --> C1["Add High-Level Context<br/>(README, architecture docs, code style guide)<br/>@project-context"]
    C1 --> C2["Add Specification Context<br/>(User Stories, BDD Scenarios)"]
    C2 --> C3["Add Relevant Code Context<br/>(Dependencies, Tests, Utils, Similar Features)"]
    
    C3 --> PlanningPhase["üéØ Stage 2: <br> PLANNING"]
    
    PlanningPhase --> P1["Discuss Feature with AI Agent<br/>(Like with Human Colleague)"]
    P1 --> P2{"Does AI Need<br/>More Context?"}
    P2 -->|Yes| P3["Provide Additional Context"]
    P2 -->|No| P4["Request Feature Roadmap<br/>(@ai-roadmap-template)"]
    P3 --> P1
    P4 --> P5["üìã Review Roadmap Carefully"]
    P5 --> P6{"Is Roadmap Good & Aligned with Business Needs? (Specifications)"}
    P6 -->|No| P7["Refine Roadmap with AI"]
    P7 --> P4
    P6 -->|Yes| TDDPhase
    
    TDDPhase["‚úÖ Stage 3: <br> TDD DEVELOPMENT STARTS"]
    
    TDDPhase --> InitChoice{"Choose TDD<br/>Approach"}
    
    InitChoice -->|Test List| TL1["üìù Create Complete Test List<br/>(Markdown or Skipped Tests)"]
    InitChoice -->|Single Test| ST1["üìù Write Simplest First Test"]
    
    TL1 --> TL2["Review Against Specifications"]
    ST1 --> CycleStart
    TL2 --> CycleStart
    
    CycleStart["üîÑ Stage 4: <br> THE TDD CYCLE<br/>(RED GREEN REFACTOR Per Test)"]
    
    %% RED PHASE
    CycleStart --> Red["üî¥ RED PHASE: Write Failing Test"]
    Red --> R1["Collaborate with AI to Write Test<br/>(@red-&-stop)"]
    R1 --> R2{"Did test fail<br/>as expected?"}
    R2 -->|Yes| RedReview
    R2 -->|No| R3["Debug/Fix test until it fails correctly<br/>"]
    R3 --> R1
    
    RedReview["‚è∏Ô∏è  AWAIT USER REVIEW (RED PHASE)<br/><b>AI MUST STOP HERE</b>"]
    RedReview --> RedApprove{"Approve<br/>RED Phase?"}
    RedApprove -->|No| R1
    RedApprove -->|Yes| Green
    
    %% GREEN PHASE
    Green["üü¢ GREEN PHASE: Make Test Pass"]
    Green --> G1["Collaborate with AI to Write Code<br/>(@green-&-stop)"]
    G1 --> G2{"Did all tests pass?"}
    G2 -->|Yes| GreenReview
    G2 -->|No| G3["Debug/Fix code until test passes<br/>"]
    G3 --> G1
    
    GreenReview["‚è∏Ô∏è  AWAIT USER REVIEW (GREEN PHASE)<br/><b>AI MUST STOP HERE</b>"]
    GreenReview --> GreenApprove{"Approve<br/>GREEN Phase?"}
    GreenApprove -->|No| G1
    GreenApprove -->|Yes| Refactor
    
    %% REFACTOR PHASE
    Refactor["üßº REFACTOR PHASE: Improve Code"]
    Refactor --> RF1["Collaborate with AI to Refactor<br/>(@refactor-&-stop)"]
    RF1 --> RF2{"Do all tests still pass?"}
    RF2 -->|Yes| RefactorReview
    RF2 -->|No| RF3["AI stops. User chooses:<br/>Fix issue or revert to green<br/>"]
    RF3 --> RF1
    
    RefactorReview["‚è∏Ô∏è  AWAIT FINAL USER REVIEW (REFACTOR PHASE)<br/><b>AI MUST STOP HERE</b>"]
    RefactorReview --> RefactorApprove{"Approve<br/>REFACTOR Phase?"}
    RefactorApprove -->|No| RF1
    RefactorApprove -->|Yes| NextTest
    
    %% ITERATION OR COMPLETION
    NextTest{"More Tests<br/>Needed?"}
    NextTest -->|Yes, Test List| PickNext["üìå Select Next Test from List<br/><i>Return to RED Phase<br/>with next test</i>"]
    NextTest -->|Yes, Single| CreateNext["üìù Design Next Test Case<br/><i>Return to RED Phase<br/>with new test</i>"]
    NextTest -->|No| Complete
    
    Complete["‚ú® Feature Complete<br/>(All Tests Green for This Feature)"] --> Deploy["üì¶ Ready for Deployment Pipeline"]
    
    %% STYLES - NO CHANGES
    style Start fill:#f9f9f9,stroke:#333,stroke-width:3px,color:#000
    style ContextPhase fill:#1976d2,stroke:#0d47a1,stroke-width:3px,color:#fff
    style C1 fill:#e3f2fd,stroke:#1976d2,stroke-width:2px,color:#000
    style C2 fill:#e3f2fd,stroke:#1976d2,stroke-width:2px,color:#000
    style C3 fill:#e3f2fd,stroke:#1976d2,stroke-width:2px,color:#000
    style PlanningPhase fill:#f57c00,stroke:#e65100,stroke-width:3px,color:#fff
    style P1 fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#000
    style P2 fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#000
    style P3 fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#000
    style P4 fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#000
    style P5 fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#000
    style P6 fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#000
    style P7 fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#000
    style TDDPhase fill:#388e3c,stroke:#1b5e20,stroke-width:3px,color:#fff
    style InitChoice fill:#e8f5e9,stroke:#388e3c,stroke-width:2px,color:#000
    style TL1 fill:#e8f5e9,stroke:#388e3c,stroke-width:2px,color:#000
    style TL2 fill:#e8f5e9,stroke:#388e3c,stroke-width:2px,color:#000
    style ST1 fill:#e8f5e9,stroke:#388e3c,stroke-width:2px,color:#000
    style CycleStart fill:#7b1fa2,stroke:#4a148c,stroke-width:3px,color:#fff
    style Red fill:#ffebee,stroke:#d32f2f,stroke-width:3px,color:#000
    style R1 fill:#ffebee,stroke:#d32f2f,stroke-width:2px,color:#000
    style R2 fill:#ffebee,stroke:#d32f2f,stroke-width:2px,color:#000
    style R3 fill:#ffebee,stroke:#d32f2f,stroke-width:2px,color:#000
    style RedReview fill:#fff9c4,stroke:#f9a825,stroke-width:4px,color:#000
    style RedApprove fill:#fff9c4,stroke:#f9a825,stroke-width:2px,color:#000
    style Green fill:#c8e6c9,stroke:#388e3c,stroke-width:3px,color:#000
    style G1 fill:#c8e6c9,stroke:#388e3c,stroke-width:2px,color:#000
    style G2 fill:#c8e6c9,stroke:#388e3c,stroke-width:2px,color:#000
    style G3 fill:#c8e6c9,stroke:#388e3c,stroke-width:2px,color:#000
    style GreenReview fill:#fff9c4,stroke:#f9a825,stroke-width:4px,color:#000
    style GreenApprove fill:#fff9c4,stroke:#f9a825,stroke-width:2px,color:#000
    style Refactor fill:#f3e5f5,stroke:#7b1fa2,stroke-width:3px,color:#000
    style RF1 fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000
    style RF2 fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000
    style RF3 fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000
    style RefactorReview fill:#fff9c4,stroke:#f9a825,stroke-width:4px,color:#000
    style RefactorApprove fill:#fff9c4,stroke:#f9a825,stroke-width:2px,color:#000
    style NextTest fill:#f5f5f5,stroke:#666,stroke-width:2px,color:#000
    style PickNext fill:#fef9e7,stroke:#f9a825,stroke-width:2px,color:#000
    style CreateNext fill:#fef9e7,stroke:#f9a825,stroke-width:2px,color:#000
    style Complete fill:#4caf50,stroke:#2e7d32,stroke-width:3px,color:#fff
    style Deploy fill:#4caf50,stroke:#2e7d32,stroke-width:3px,color:#fff