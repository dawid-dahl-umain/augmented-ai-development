graph TD
    Start["üöÄ Acceptance Testing Begins<br/>(BDD Scenarios Ready)"]
    
    Start --> ContextPhase["üìö Stage 1: CONTEXT PROVIDING<br/><br/>(Project Setup, BDD Scenarios, Existing Patterns)"]
    
    ContextPhase --> PlanningPhase["ü§ù Stage 2: PLANNING & ANALYSIS<br/><br/>(Extract Domain Concepts, Choose Protocol Type)<br/><br/>Output: Protocol Driver Strategy Roadmap"]
    
    PlanningPhase --> FirstCheck{"First Acceptance Test<br/>for this Feature?"}
    FirstCheck -->|Yes| CreateUtils["Create Core Utilities<br/>(DslContext, Params, BaseDSL)"]
    FirstCheck -->|No| ReuseUtils["Reuse Existing DSL/Drivers"]
    
    CreateUtils --> ATCycle
    ReuseUtils --> ATCycle
    
    ATCycle["üîÑ Stage 3: THREE-PHASE TEST CYCLE"]
    
    %% PHASE 1 - RED-like
    ATCycle --> Phase1["üî¥ PHASE 1: Generate Executable Spec & DSL"]
    Phase1 --> P1_Act["Collaborate with AI to:<br/><br/>**Create Executable Specification & DSL Layer**<br/><br/>(Natural Language Methods, Functional/Temporal Isolation)"] 
    P1_Act --> P1_Check{"Executable Spec<br/>Fails?"}
    P1_Check -->|No| P1_Fix["Debug: Spec Should Fail<br/>(Not Implemented Yet)"]
    P1_Check -->|Yes| P1_Review
    P1_Fix --> P1_Act
    
    P1_Review["‚è∏Ô∏è AWAIT USER REVIEW<br/><b>Executable Spec & DSL Approved?</b>"]
    P1_Review --> P1_Approve{"Approve?"}
    P1_Approve -->|No| P1_Act
    P1_Approve -->|Yes| Phase2
    
    %% PHASE 2 - GREEN-like
    Phase2["üü¢ PHASE 2: Implement Protocol Driver & SUT Connection"]
    Phase2 --> P2_Act["Collaborate with AI to:<br/><br/>**Build Protocol Driver Following Stage 2 Roadmap**<br/><br/>(Connection Strategy, Atomic Operations, External Stubs)"]
    P2_Act --> P2_Check{"Executable Spec<br/>Passes?"}
    P2_Check -->|No| P2_Fix["Debug Driver Implementation"]
    P2_Check -->|Yes| P2_Review
    P2_Fix --> P2_Act
    
    P2_Review["‚è∏Ô∏è AWAIT USER REVIEW<br/><b>Protocol Driver Working?</b>"]
    P2_Review --> P2_Approve{"Approve?"}
    P2_Approve -->|No| P2_Act
    P2_Approve -->|Yes| Phase3
    
    %% PHASE 3 - REFACTOR-like
    Phase3["üßº PHASE 3: Refactor Layers & Validate Isolation"]
    Phase3 --> P3_Act["Collaborate with AI to:<br/><br/>**Evaluate & Refactor If Needed**<br/><br/>(Polish Layers, Verify Three Isolations, 1:1 BDD Mapping)"]
    P3_Act --> P3_Check{"Executable Spec<br/>Still Passes?"}
    P3_Check -->|No| P3_Fix["Fix Regression"]
    P3_Check -->|Yes| P3_Review
    P3_Fix --> P3_Act
    
    P3_Review["‚è∏Ô∏è AWAIT FINAL REVIEW<br/><b>Ready for Next Scenario?</b>"]
    P3_Review --> P3_Approve{"Approve?"}
    P3_Approve -->|No| P3_Act
    P3_Approve -->|Yes| NextScenario
    
    %% COMPLETION
    NextScenario{"More BDD<br/>Scenarios?"}
    NextScenario -->|Yes| NextInstruction["üìå Process Next Scenario<br/><br/><i>Return to Stage 3 with same DSL/Drivers</i>"]
    NextScenario -->|No| Complete
    
    Complete["‚ú® Feature Complete<br/><br/>(All BDD Scenarios Passing)"]
    
    %% STYLES - Match AAID colors
    style Start fill:#f9f9f9,stroke:#333,stroke-width:3px,color:#000
    style ContextPhase fill:#1976d2,stroke:#0d47a1,stroke-width:3px,color:#fff
    style PlanningPhase fill:#f57c00,stroke:#e65100,stroke-width:3px,color:#fff
    style FirstCheck fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#000
    style CreateUtils fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#000
    style ReuseUtils fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#000
    style ATCycle fill:#7b1fa2,stroke:#4a148c,stroke-width:3px,color:#fff
    
    %% Phase 1 - Red theme
    style Phase1 fill:#ffebee,stroke:#d32f2f,stroke-width:3px,color:#000
    style P1_Act fill:#ffebee,stroke:#d32f2f,stroke-width:2px,color:#000
    style P1_Check fill:#ffebee,stroke:#d32f2f,stroke-width:2px,color:#000
    style P1_Fix fill:#ffebee,stroke:#d32f2f,stroke-width:2px,color:#000
    style P1_Review fill:#fff9c4,stroke:#f9a825,stroke-width:4px,color:#000
    style P1_Approve fill:#fff9c4,stroke:#f9a825,stroke-width:2px,color:#000
    
    %% Phase 2 - Green theme
    style Phase2 fill:#c8e6c9,stroke:#388e3c,stroke-width:3px,color:#000
    style P2_Act fill:#c8e6c9,stroke:#388e3c,stroke-width:2px,color:#000
    style P2_Check fill:#c8e6c9,stroke:#388e3c,stroke-width:2px,color:#000
    style P2_Fix fill:#c8e6c9,stroke:#388e3c,stroke-width:2px,color:#000
    style P2_Review fill:#fff9c4,stroke:#f9a825,stroke-width:4px,color:#000
    style P2_Approve fill:#fff9c4,stroke:#f9a825,stroke-width:2px,color:#000
    
    %% Phase 3 - Purple theme (refactor)
    style Phase3 fill:#f3e5f5,stroke:#7b1fa2,stroke-width:3px,color:#000
    style P3_Act fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000
    style P3_Check fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000
    style P3_Fix fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000
    style P3_Review fill:#fff9c4,stroke:#f9a825,stroke-width:4px,color:#000
    style P3_Approve fill:#fff9c4,stroke:#f9a825,stroke-width:2px,color:#000
    
    %% Completion
    style NextScenario fill:#f5f5f5,stroke:#666,stroke-width:2px,color:#000
    style NextInstruction fill:#fef9e7,stroke:#f9a825,stroke-width:2px,color:#000
    style Complete fill:#4caf50,stroke:#2e7d32,stroke-width:3px,color:#fff